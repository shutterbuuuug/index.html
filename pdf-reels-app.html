<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#667eea">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="description" content="Transform your PDFs into swipeable Instagram-style stories">
  <title>PDF Reels - Daily Digest</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlBERiBSZWVscyAtIERhaWx5IERpZ2VzdCIsCiAgInNob3J0X25hbWUiOiAiUERGIFJlZWxzIiwKICAiZGVzY3JpcHRpb24iOiAiVHJhbnNmb3JtIHlvdXIgUERGcyBpbnRvIHN3aXBlYWJsZSBJbnN0YWdyYW0tc3R5bGUgc3RvcmllcyIsCiAgInN0YXJ0X3VybCI6ICIvIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMDAwMDAwIiwKICAidGhlbWVfY29sb3IiOiAiIzY2N2VlYSIsCiAgIm9yaWVudGF0aW9uIjogInBvcnRyYWl0IiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxOTIgMTkyJyUzRSUzQ2RlZnMlM0UlM0NsaW5lYXJHcmFkaWVudCBpZD0nZ3JhZCcgeDElM0QnMCUyNScgeTElM0QnMCUyNScgeDIlM0QnMTAwJTI1JyB5MiUzRCcxMDAlMjUnJTNFJTNDc3RvcCBvZmZzZXQlM0QnMCUyNScgc3R5bGUlM0Qnc3RvcC1jb2xvciUzQSUyMzY2N2VlYSUzQnN0b3Atb3BhY2l0eSUzQTEnIC8lM0UlM0NzdG9wIG9mZnNldCUzRCcxMDAlMjUnIHN0eWxlJTNEJ3N0b3AtY29sb3IlM0ElMjM3NjRiYTIlM0JzdG9wLW9wYWNpdHklM0ExJyAvJTNFJTNDL2xpbmVhckdyYWRpZW50JTNFJTNDL2RlZnMlM0UlM0NyZWN0IHdpZHRoJTNEJzE5MicgaGVpZ2h0JTNEJzE5MicgZmlsbCUzRCd1cmwoJTIzZ3JhZCknIHJ4JTNEJzQ1Jy8lM0UlM0NwYXRoIGZpbGwlM0Qnd2hpdGUnIGQlM0QnTTYwIDYwaDcydjEySDYweicvJTNFJTNDcGF0aCBmaWxsJTNEJ3doaXRlJyBkJTNEJ002MCA4NGg3MnY4SDYweicvJTNFJTNDcGF0aCBmaWxsJTNEJ3doaXRlJyBkJTNEJ002MCAxMDRoNzJ2OEg2MHonLyUzRSUzQ3BhdGggZmlsbCUzRCd3aGl0ZScgZCUzRCdNNjAgMTI0aDQ4djhINjB6Jy8lM0UlM0Mvc3ZnJTNFIiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIiwKICAgICAgInB1cnBvc2UiOiAiYW55IG1hc2thYmxlIgogICAgfSwKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgdmlld0JveD0nMCAwIDUxMiA1MTInJTNFJTNDZGVmcyUzRSUzQ2xpbmVhckdyYWRpZW50IGlkPSdncmFkJyB4MSUzRCcwJTI1JyB5MSUzRCcwJTI1JyB4MiUzRCcxMDAlMjUnIHkyJTNEJzEwMCUyNSclM0UlM0NzdG9wIG9mZnNldCUzRCcwJTI1JyBzdHlsZSUzRCdzdG9wLWNvbG9yJTNBJTIzNjY3ZWVhJTNCc3RvcC1vcGFjaXR5JTNBMScgLyUzRSUzQ3N0b3Agb2Zmc2V0JTNEJzEwMCUyNScgc3R5bGUlM0Qnc3RvcC1jb2xvciUzQSUyMzc2NGJhMiUzQnN0b3Atb3BhY2l0eSUzQTEnIC8lM0UlM0MvbGluZWFyR3JhZGllbnQlM0UlM0MvZGVmcyUzRSUzQ3JlY3Qgd2lkdGglM0QnNTEyJyBoZWlnaHQlM0QnNTEyJyBmaWxsJTNEJ3VybCglMjNncmFkKScgcnglM0QnMTIwJy8lM0UlM0NwYXRoIGZpbGwlM0Qnd2hpdGUnIGQlM0QnTTE2MCAxNjBoMTkydjMySDE2MHonLyUzRSUzQ3BhdGggZmlsbCUzRCd3aGl0ZScgZCUzRCdNMTYwIDIyNGgxOTJ2MjBIMTYweicvJTNFJTNDcGF0aCBmaWxsJTNEJ3doaXRlJyBkJTNEJ00xNjAgMjc2aDE5MnYyMEgxNjB6Jy8lM0UlM0NwYXRoIGZpbGwlM0Qnd2hpdGUnIGQlM0QnTTE2MCAzMzBoMTI4djIwSDE2MHonLyUzRSUzQy9zdmclM0UiLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiLAogICAgICAicHVycG9zZSI6ICJhbnkgbWFza2FibGUiCiAgICB9CiAgXQp9">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React and ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    
    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }
    
    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    /* Smooth scrolling for snap */
    .snap-container {
      scroll-snap-type: y mandatory;
      scroll-behavior: smooth;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;
    const { Upload, Bookmark, BookmarkCheck, Home, Library, ChevronUp, ChevronDown } = lucide;

    function PDFReelsApp() {
      const [cards, setCards] = useState([]);
      const [currentIndex, setCurrentIndex] = useState(0);
      const [bookmarks, setBookmarks] = useState([]);
      const [isProcessing, setIsProcessing] = useState(false);
      const [fileName, setFileName] = useState('');
      const [activeTab, setActiveTab] = useState('home');
      const [touchStart, setTouchStart] = useState(0);
      const [touchEnd, setTouchEnd] = useState(0);
      const scrollContainerRef = useRef(null);
      const fileInputRef = useRef(null);

      // Load saved data from localStorage
      useEffect(() => {
        const savedCards = localStorage.getItem('pdfCards');
        const savedBookmarks = localStorage.getItem('pdfBookmarks');
        const savedFileName = localStorage.getItem('pdfFileName');
        const savedIndex = localStorage.getItem('currentIndex');

        if (savedCards) {
          setCards(JSON.parse(savedCards));
          setBookmarks(JSON.parse(savedBookmarks || '[]'));
          setFileName(savedFileName || 'Unknown PDF');
          setCurrentIndex(parseInt(savedIndex || '0', 10));
        }
      }, []);

      // Save to localStorage
      useEffect(() => {
        if (cards.length > 0) {
          localStorage.setItem('pdfCards', JSON.stringify(cards));
          localStorage.setItem('pdfBookmarks', JSON.stringify(bookmarks));
          localStorage.setItem('pdfFileName', fileName);
          localStorage.setItem('currentIndex', currentIndex.toString());
        }
      }, [cards, bookmarks, fileName, currentIndex]);

      // Generate cards from text
      const generateCards = (text) => {
        const sections = text.split(/\n\n+/).filter(s => s.trim().length > 0);
        const generatedCards = [];
        let currentCard = { title: '', content: '', index: 0 };

        for (let i = 0; i < sections.length; i++) {
          const section = sections[i].trim();
          
          const isHeader = section.length < 100 && (
            /^[#\d]/.test(section) || 
            /^[A-Z][^.!?]*$/.test(section) ||
            section.split(' ').length < 10
          );

          if (isHeader && !currentCard.title) {
            currentCard.title = section;
          } else if (currentCard.content.length + section.length < 600) {
            currentCard.content += (currentCard.content ? '\n\n' : '') + section;
          } else {
            if (currentCard.content || currentCard.title) {
              currentCard.index = generatedCards.length;
              generatedCards.push({ ...currentCard });
            }
            currentCard = {
              title: isHeader ? section : `Section ${generatedCards.length + 1}`,
              content: isHeader ? '' : section,
              index: generatedCards.length
            };
          }
        }

        if (currentCard.content || currentCard.title) {
          currentCard.index = generatedCards.length;
          generatedCards.push(currentCard);
        }

        return generatedCards.map((card, idx) => ({
          ...card,
          title: card.title || `Card ${idx + 1}`
        }));
      };

      // Handle PDF upload
      const handleFileUpload = async (event) => {
        const file = event.target.files[0];
        if (!file || file.type !== 'application/pdf') {
          alert('Please upload a PDF file');
          return;
        }

        setIsProcessing(true);
        setFileName(file.name);

        try {
          const base64Data = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => {
              const base64 = reader.result.split(',')[1];
              resolve(base64);
            };
            reader.onerror = () => reject(new Error('Failed to read file'));
            reader.readAsDataURL(file);
          });

          const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 16000,
              messages: [
                {
                  role: 'user',
                  content: [
                    {
                      type: 'document',
                      source: {
                        type: 'base64',
                        media_type: 'application/pdf',
                        data: base64Data,
                      },
                    },
                    {
                      type: 'text',
                      text: 'Extract all text from this PDF. Preserve the structure with headers and paragraphs. Use double newlines between sections. Return ONLY the text content.',
                    },
                  ],
                },
              ],
            }),
          });

          const data = await response.json();
          const extractedText = data.content[0].text;

          const generatedCards = generateCards(extractedText);
          setCards(generatedCards);
          setCurrentIndex(0);
          setBookmarks([]);
          setActiveTab('home');
        } catch (error) {
          console.error('Error processing PDF:', error);
          alert('Error processing PDF. Please try again.');
        } finally {
          setIsProcessing(false);
        }
      };

      // Bookmark functions
      const toggleBookmark = (index) => {
        setBookmarks(prev => {
          if (prev.includes(index)) {
            return prev.filter(i => i !== index);
          } else {
            return [...prev, index].sort((a, b) => a - b);
          }
        });
      };

      const isBookmarked = (index) => bookmarks.includes(index);

      // Navigation
      const scrollToCard = (index) => {
        setCurrentIndex(index);
        if (scrollContainerRef.current) {
          const cardHeight = window.innerHeight;
          scrollContainerRef.current.scrollTo({
            top: index * cardHeight,
            behavior: 'smooth'
          });
        }
      };

      const handleScroll = () => {
        if (scrollContainerRef.current) {
          const scrollTop = scrollContainerRef.current.scrollTop;
          const cardHeight = window.innerHeight;
          const newIndex = Math.round(scrollTop / cardHeight);
          if (newIndex !== currentIndex && newIndex >= 0 && newIndex < cards.length) {
            setCurrentIndex(newIndex);
          }
        }
      };

      // Touch handlers
      const handleTouchStart = (e) => {
        setTouchStart(e.targetTouches[0].clientY);
      };

      const handleTouchMove = (e) => {
        setTouchEnd(e.targetTouches[0].clientY);
      };

      const handleTouchEnd = () => {
        if (touchStart - touchEnd > 50 && currentIndex < cards.length - 1) {
          scrollToCard(currentIndex + 1);
        }
        if (touchStart - touchEnd < -50 && currentIndex > 0) {
          scrollToCard(currentIndex - 1);
        }
      };

      const displayedCards = activeTab === 'bookmarks' 
        ? cards.filter((_, idx) => bookmarks.includes(idx))
        : cards;

      return (
        <div className="h-screen w-screen bg-black overflow-hidden relative">
          {cards.length === 0 ? (
            <div className="h-full flex items-center justify-center p-6 bg-gradient-to-br from-purple-900 via-pink-900 to-red-900">
              <div className="w-full max-w-sm">
                <div className="text-center mb-8">
                  <div className="w-24 h-24 bg-white rounded-full flex items-center justify-center mx-auto mb-6 shadow-2xl">
                    <Library className="w-12 h-12 text-purple-600" />
                  </div>
                  <h1 className="text-4xl font-bold text-white mb-3">
                    PDF Reels
                  </h1>
                  <p className="text-purple-200 text-lg">
                    Transform your PDFs into swipeable stories
                  </p>
                </div>

                <div
                  onClick={() => fileInputRef.current?.click()}
                  className="bg-white/10 backdrop-blur-lg border-2 border-white/30 rounded-3xl p-12 cursor-pointer hover:bg-white/20 transition-all duration-300 shadow-2xl"
                >
                  <Upload className="w-16 h-16 text-white mx-auto mb-4" />
                  <p className="text-xl font-bold text-white mb-2 text-center">
                    {isProcessing ? 'Processing...' : 'Upload PDF'}
                  </p>
                  <p className="text-purple-200 text-center">
                    Tap to select from your device
                  </p>
                </div>

                <input
                  ref={fileInputRef}
                  type="file"
                  accept="application/pdf"
                  onChange={handleFileUpload}
                  className="hidden"
                />

                {isProcessing && (
                  <div className="mt-8 text-center">
                    <div className="flex space-x-2 justify-center mb-4">
                      <div className="w-3 h-3 bg-white rounded-full animate-bounce" style={{ animationDelay: '0ms' }}></div>
                      <div className="w-3 h-3 bg-white rounded-full animate-bounce" style={{ animationDelay: '150ms' }}></div>
                      <div className="w-3 h-3 bg-white rounded-full animate-bounce" style={{ animationDelay: '300ms' }}></div>
                    </div>
                    <p className="text-white">Creating your reels...</p>
                  </div>
                )}
              </div>
            </div>
          ) : (
            <>
              <div
                ref={scrollContainerRef}
                onScroll={handleScroll}
                onTouchStart={handleTouchStart}
                onTouchMove={handleTouchMove}
                onTouchEnd={handleTouchEnd}
                className="h-full overflow-y-scroll snap-y snap-mandatory scrollbar-hide"
              >
                {displayedCards.map((card, idx) => {
                  const actualIndex = activeTab === 'bookmarks' 
                    ? cards.findIndex(c => c.index === card.index)
                    : idx;

                  return (
                    <div
                      key={card.index}
                      className="h-screen w-full snap-start snap-always flex items-center justify-center relative"
                      style={{
                        background: `linear-gradient(${180 + actualIndex * 45}deg, #667eea 0%, #764ba2 50%, #f093fb 100%)`
                      }}
                    >
                      <div className="w-full h-full flex flex-col p-6 pt-16 pb-24">
                        <div className="mb-6">
                          <div className="flex items-start justify-between mb-4">
                            <div className="flex-1">
                              <h2 className="text-2xl font-bold text-white mb-2 leading-tight">
                                {card.title}
                              </h2>
                              <p className="text-white/70 text-sm">
                                {actualIndex + 1} of {cards.length}
                              </p>
                            </div>
                            <button
                              onClick={() => toggleBookmark(card.index)}
                              className="ml-4 p-3 bg-white/20 backdrop-blur-md rounded-full hover:bg-white/30 transition-all"
                            >
                              {isBookmarked(card.index) ? (
                                <BookmarkCheck className="w-6 h-6 text-white" />
                              ) : (
                                <Bookmark className="w-6 h-6 text-white" />
                              )}
                            </button>
                          </div>
                        </div>

                        <div className="flex-1 overflow-y-auto scrollbar-hide">
                          <div className="bg-white/10 backdrop-blur-lg rounded-3xl p-6 shadow-2xl border border-white/20">
                            {card.content.split('\n\n').map((para, pIdx) => (
                              <p key={pIdx} className="text-white text-lg leading-relaxed mb-4 last:mb-0">
                                {para}
                              </p>
                            ))}
                          </div>
                        </div>

                        <div className="mt-6 flex items-center justify-center gap-4">
                          {actualIndex > 0 && (
                            <button
                              onClick={() => scrollToCard(actualIndex - 1)}
                              className="p-2 bg-white/20 backdrop-blur-md rounded-full"
                            >
                              <ChevronUp className="w-5 h-5 text-white" />
                            </button>
                          )}
                          {actualIndex < cards.length - 1 && (
                            <button
                              onClick={() => scrollToCard(actualIndex + 1)}
                              className="p-2 bg-white/20 backdrop-blur-md rounded-full animate-bounce"
                            >
                              <ChevronDown className="w-5 h-5 text-white" />
                            </button>
                          )}
                        </div>
                      </div>

                      <div className="absolute top-4 left-0 right-0 px-6">
                        <div className="flex gap-1">
                          {cards.map((_, i) => (
                            <div
                              key={i}
                              className="flex-1 h-1 bg-white/30 rounded-full overflow-hidden"
                            >
                              <div
                                className={`h-full bg-white transition-all duration-300 ${
                                  i === actualIndex ? 'w-full' : i < actualIndex ? 'w-full' : 'w-0'
                                }`}
                              ></div>
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>

              <div className="absolute bottom-0 left-0 right-0 bg-black/80 backdrop-blur-lg border-t border-white/10">
                <div className="flex items-center justify-around py-4 px-6">
                  <button
                    onClick={() => setActiveTab('home')}
                    className={`flex flex-col items-center gap-1 transition-all ${
                      activeTab === 'home' ? 'text-white' : 'text-white/50'
                    }`}
                  >
                    <Home className="w-6 h-6" />
                    <span className="text-xs font-medium">All</span>
                  </button>

                  <button
                    onClick={() => setActiveTab('bookmarks')}
                    className={`flex flex-col items-center gap-1 transition-all ${
                      activeTab === 'bookmarks' ? 'text-white' : 'text-white/50'
                    }`}
                  >
                    <Bookmark className="w-6 h-6" />
                    <span className="text-xs font-medium">Saved ({bookmarks.length})</span>
                  </button>

                  <button
                    onClick={() => {
                      if (confirm('Upload a new PDF? This will clear current content.')) {
                        setCards([]);
                        setBookmarks([]);
                        setFileName('');
                        setCurrentIndex(0);
                        localStorage.clear();
                      }
                    }}
                    className="flex flex-col items-center gap-1 text-white/50 hover:text-white transition-all"
                  >
                    <Upload className="w-6 h-6" />
                    <span className="text-xs font-medium">New</span>
                  </button>
                </div>
              </div>
            </>
          )}
        </div>
      );
    }

    // Render app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<PDFReelsApp />);

    // Service Worker Registration for PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('data:text/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgZnVuY3Rpb24oZXZlbnQpIHsKICBldmVudC53YWl0VW50aWwoc2VsZi5za2lwV2FpdGluZygpKTsKfSk7CgpzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2ZldGNoJywgZnVuY3Rpb24oZXZlbnQpIHsKICBldmVudC5yZXNwb25kV2l0aChmZXRjaChldmVudC5yZXF1ZXN0KSk7Cn0pOw==')
          .then(() => console.log('Service Worker registered'))
          .catch(err => console.log('Service Worker registration failed:', err));
      });
    }
  </script>
</body>
</html>
